---
alwaysApply: true
---

You are an expert World of Warcraft Addon Developer specializing in Lua 5.1 and the WoW API (Patch 11.x The War Within). Your task is to generate secure, performant, and TOS-compliant code for the "Warband Nexus" addon.

1. Language & Syntax Constraints (Lua 5.1)
Strictly Lua 5.1: Do NOT use features from Lua 5.2+ (e.g., goto, bitwise operators like &, |, <<). WoW does not support them.

Variable Scoping:

ALWAYS use local variables. Global namespace pollution is strictly prohibited.

Exception: The main Addon Object/Table logic created via LibStub.

String Manipulation:

Use .. for simple concatenation.

For loop-heavy concatenation, use table.concat to avoid memory churn.

Loops: Prefer ipairs for array-like tables (1-based index) and pairs for dictionary-like tables.

Semicolons: Do not use semicolons ; at the end of lines unless resolving ambiguity.

2. WoW API & Namespace Strategy
Namespace Prioritization:

Always prefer modern C_ namespaces over deprecated globals.

YES: C_Container.GetContainerItemInfo, C_Bank.DepositMoney, C_Timer.After

NO: GetContainerItemInfo, DepositReagentBank, GetItemInfo (unless no C_ equivalent exists).

Warband Integration:

Use Enum.BagIndex.AccountBankTab_1 through _5 for targeting Warband slots.

Use Enum.BankType.Account for bank type checks.

Event Handling:

Prefer AceEvent-3.0 library methods (self:RegisterEvent) over raw Frame:SetScript("OnEvent") unless creating a secure XML frame.

3. Framework & Libraries (Ace3)
Assume the Ace3 framework is present in Libs/.

Initialization: Use AceAddon-3.0 for the main object:lua WarbandNexus = LibStub("AceAddon-3.0"):NewAddon("WarbandNexus", "AceEvent-3.0", "AceConsole-3.0", "AceHook-3.0")

Configuration: Use AceConfig-3.0 and AceDB-3.0 for options and saved variables. Do not write raw SlashCmdList handlers manually.

4. Performance & Memory Management
Table Recycling: Do not create new tables {} inside OnUpdate or frequent event handlers. Use a pool or wipe() existing tables.

Texture/Frame Reuse: Do not create frames dynamically in runtime loops. Create pools at load time.

5. Documentation & Type Safety
LuaLS Annotations: Must provide Lua Language Server annotations for complex functions.

Lua
---@param bagID number The ID of the bag (Enum.BagIndex)
---@param slotID number The ID of the slot
---@return table|nil itemInfo The item information table
function WarbandNexus:GetItem(bagID, slotID)... end
6. Prohibited Patterns (Anti-Pattern & ToS)
No Automation: Do NOT generate code that automatically moves items without hardware events, unless using purely protected API calls like SortBags.

No Protected Call Violations: Do not attempt to call CastSpellByName or UseContainerItem in insecure execution paths.


Bu kurallar seti[7, 8] ve [7] numaralı kaynaklarda belirtilen en iyi uygulamaların, WoW eklenti geliştirme ekosistemine uyarlanmış halidir. Özellikle "No Automation" maddesi, yasal uyumluluk bölümünde detaylandırılacak olan riskleri minimize etmek için yapay zekaya verilmiş kesin bir emirdir.

### 3.2. Kod Üretim Prompt Mühendisliği ve Şablonlar

Cursor ile çalışırken, karmaşık mantıkları tek bir prompt ile istemek yerine, modüler ve zincirleme (chain-of-thought) prompt stratejileri kullanmak daha verimli sonuçlar üretir. Warband Nexus için kritik fonksiyonların üretilmesinde kullanılacak prompt şablonları aşağıda detaylandırılmıştır.

#### 3.2.1. İskelet ve Kütüphane Entegrasyonu

Bu prompt, projenin temelini atar ve Ace3 kütüphanelerinin doğru şekilde bağlanmasını sağlar.

**Prompt:**
> "Act as a Lead WoW Addon Developer. Generate the core file structure for 'Warband Nexus'.
> 1. Create `WarbandNexus.toc` for Interface 110002. Include references to Ace3 libraries (AceAddon, AceEvent, AceDB, AceGUI, AceConfig) via `Embeds.xml`. Define `## SavedVariables: WarbandNexusDB`.
> 2. Create `Core.lua`. Initialize the addon object using `LibStub("AceAddon-3.0")`.
> 3. Implement standard `OnInitialize` (load database defaults) and `OnEnable` (register events) methods.
> 4. Ensure the database defaults include a profile-based structure with a boolean setting `autoRepair` and a table `ignoredSlots`.
> Use the defined.cursorrules for syntax and style."

#### 3.2.2. Warband Envanter Tarayıcı (Scanner) Modülü

Bu modül, Warband bankasındaki tüm eşyaları tarayarak yerel bir veritabanına kaydeder.

**Prompt:**
> "Write a Lua module `Scanner.lua` for Warband Nexus.
> - Function `ScanWarbandBank()`: Iterate through `Enum.BagIndex.AccountBankTab_1` to `5`.
> - Inner Loop: Iterate slots using `C_Container.GetContainerNumSlots(bagID)`.
> - Data Fetch: Use `C_Container.GetContainerItemInfo(bagID, slotID)` to get itemID, count, quality, and link.
> - Storage: Save this data into `self.db.global.warbandCache`.
> - Logic Check: Wrap the execution in a check ensuring `C_Bank.IsBankOpen(Enum.BankType.Account)` returns true. If the bank is not open, print a debug message and return.
> - Optimization: Use `wipe()` on local cache tables before repopulating to avoid garbage collection spikes."

[9, 10]

#### 3.2.3. Kullanıcı Arayüzü (GUI) ve Konfigürasyon

AceConfig-3.0 kullanarak ayarlar menüsü oluşturmak için kullanılan prompt.

**Prompt:**
> "Generate a configuration table `options` for AceConfig-3.0.
> - Structure: The table must support the 'Blizzard Options' panel integration.
> - Elements:
>   - A header 'General Settings'.
>   - A toggle 'Enable Auto-Sort' (key: `autoSort`).
>   - A slider 'Gold Reserve' (key: `minGold`, min: 0, max: 1000000, step: 1000).
>   - A multiselect dropdown for 'Ignored Tabs' (1 through 5).
> - Handler: Ensure `get` and `set` functions interact correctly with `self.db.profile`."

[11, 12, 13]

## 4. Kurulum Adımları ve Klasör Mimarisi

Sürdürülebilir ve hatasız bir eklenti için dosya hiyerarşisinin standartlara uygun olması gerekir. Warband Nexus için önerilen yapı şöyledir:

### 4.1. Dosya Hiyerarşisi

WarbandNexus/
├── WarbandNexus.toc          # Oyunun okuduğu manifesto dosyası
├── embeds.xml                # Kütüphane yükleyicisi
├── libs/                     # Üçüncü parti kütüphaneler
│   ├── LibStub/              # Kütüphane versiyon yöneticisi
│   ├── CallbackHandler-1.0/  # Olay geri çağırım yöneticisi
│   ├── AceAddon-3.0/         # Ana çatı
│   ├── AceEvent-3.0/         # Olay yönetimi
│   ├── AceDB-3.0/            # Veritabanı yönetimi
│   ├── AceGUI-3.0/           # Grafik arayüz widget'ları
│   └── AceConfig-3.0/        # Ayar menüsü oluşturucu
├── Locales/                  # Çoklu dil desteği
│   ├── enUS.lua
│   └── trTR.lua
├── Core.lua                  # Başlatma ve ana kontrol mantığı
├── Config.lua                # Ayar tabloları ve varsayılanlar
├── Modules/                  # İşlevsel modüller
│   ├── Scanner.lua           # Envanter tarama
│   ├── Banker.lua            # Altın/Eşya yatırma mantığı
│   └── UI.lua                # Görsel arayüz elemanları
└── Media/                    # Özel dokular (textures)
    └── icon.tga
[14, 15]

### 4.2. Kurulum ve Başlatma Akışı

1.  **Klasör Oluşturma:** WoW kurulum dizininde `_retail_/Interface/AddOns/` altına `WarbandNexus` klasörü açılır.
2.  **Kütüphane Temini:** Ace3 kütüphanesi [11, 16] CurseForge veya GitHub üzerinden indirilip `libs` klasörüne ayıklanır. `.toc` dosyasında bu kütüphanelerin manuel olarak listelenmesi yerine `embeds.xml` kullanımı, kod karmaşasını önler.
3.  **TOC Yapılandırması:** `WarbandNexus.toc` dosyasının en üstüne `## Interface: 110002` (veya güncel sürüm) yazılmalıdır. `## SavedVariables: WarbandNexusDB` satırı, verilerin (taranan envanterin) oturumlar arasında saklanmasını sağlar.[17]
4.  **Hata Ayıklama:** İlk kurulumda `Core.lua` içine `print("Warband Nexus Loaded")` yazılarak eklentinin oyun tarafından tanınıp tanınmadığı kontrol edilir. Eğer yüklenmiyorsa, genellikle `.toc` dosyasındaki dosya yolları (path) hatalıdır veya klasör adı ile TOC adı eşleşmiyordur.[18]

## 5. Yasal Uygunluk: Otomasyon ve ToS Sınırları

Warband Nexus'un teknik başarısı kadar, yasal zeminde ayakta kalması da hayati önem taşır. Blizzard, "Botting" (bot kullanımı) ve "Automation" (otomasyon) konularında sıfır tolerans politikası izler. Eklenti geliştiricisi olarak bu gri alanlarda gezinirken uyulması gereken "Altın Kurallar" vardır.

### 5.1. "Bir Donanım Olayı = Bir Eylem" Doktrini

Blizzard'ın eklenti politikasının temel taşı, oyun içindeki her kritik eylemin (büyü yapma, eşya kullanma, eşya taşıma, hedef seçme) oyuncunun fiziksel bir donanım etkileşimi (tuş basımı, fare tıklaması) ile tetiklenmesi zorunluluğudur.
*   **Yasaklı Senaryo:** Oyuncu bankayı açtığında, hiçbir tuşa basmadan eklentinin otomatik olarak envanterdeki tüm otları Warband bankasına taşıması. Bu, "unattended gameplay" (gözetimsiz oyun) sınıfına girer ve ban sebebidir.[19, 20]
*   **Uyumlu Senaryo:** Banka penceresine bir "Otları Yatır" butonu eklenmesi. Oyuncu bu butona bastığında işlemin gerçekleşmesi.

### 5.2. Protected Functions ve Güvenlik Çerçevesi

WoW API'sinde `UseContainerItem`, `PickupContainerItem`, `CastSpellByName` gibi fonksiyonlar "Protected" (Korumalı) olarak işaretlenmiştir. Bu fonksiyonlar, standart bir Lua scripti içinden, eğer o script bir donanım olayı tarafından doğrudan tetiklenmiyorsa çağrılamaz.
*   **SecureTemplate Kullanımı:** Eğer Warband Nexus, oyuncuya tek tıklamayla bir eşyayı kullanma veya taşıma imkanı sunacaksa, butonun `SecureActionButtonTemplate` sınıfından türetilmesi gerekir. Bu şablon, Blizzard'ın "Güvenli Yürütme Ortamı" (Secure Execution Environment) içinde çalışır ve kodun kısıtlı yetkilerle işlem yapmasına izin verir.[9, 21]
*   **Taint (Leke) Sorunu:** Güvenli olmayan (tainted) bir kod parçası, güvenli bir değişkene veya fonksiyona dokunursa, "Action Blocked" hatası alınır ve arayüz kilitlenir. Warband Nexus, arayüz elemanlarını oluştururken Blizzard'ın varsayılan banka arayüzüne (Blizzard_AccountBankUI) müdahale etmekten kaçınmalı, bunun yerine kendi bağımsız çerçevesini (frame) kullanmalıdır.

### 5.3. Warband Nexus İçin Güvenli Özellik Seti

ToS analizi [22, 23, 24, 25] ışığında, Warband Nexus şu özellikleri güvenle sunabilir:
1.  **Veri Görselleştirme:** Tüm alt karakterlerin banka içeriklerini listeleme (Sadece okuma işlemi olduğu için tamamen yasaldır).
2.  **Sıralama (Sorting):** Blizzard'ın sunduğu `C_Container.SortAccountBankBags()` fonksiyonunu çağıran arayüz butonları.[9] Bu fonksiyon sunucu taraflı çalışır ve güvenlidir.
3.  **Filtreleme ve Arama:** Oyuncunun çantasındaki eşyaları belirli kriterlere (Level, Rarity) göre vurgulama (Glow effect).
4.  **Yatırma Kuyruğu:** Oyuncunun yatırmak istediği eşyaları seçmesi ve bir "Onayla" butonu ile işlemi başlatması. Bu durumda eklenti, her eşya transferi için oyuncudan bir tıklama istemese bile, sürecin tamamı oyuncunun inisiyatifiyle başladığı için genellikle tolere edilir (TSM Mailing mantığı). Ancak en güvenli yöntem, her "stack" (yığın) transferi için bir gecikme (throttle) koymak veya oyuncunun tıklamasını beklemektir.

## 6. Sürdürülebilirlik ve Performans Stratejileri

Bir eklentinin "sürdürülebilir" olması, oyunun sürekli değişen yapısına (yeni yamalar, API değişiklikleri) dirençli olması ve performans açısından oyuncunun bilgisayarını yormaması anlamına gelir.

### 6.1. Bellek Yönetimi ve Çöp Toplama (Garbage Collection)

Lua 5.1, "Incremental Garbage Collector" (Artımlı Çöp Toplayıcı) kullanır. Bu mekanizma, kullanılmayan bellek bloklarını temizlerken işlemciyi (CPU) meşgul eder. Eklenti kodunda sık sık geçici tablolar oluşturulup terk edilirse (Memory Churn), oyun anlık takılmalar (micro-stutters) yaşar.
*   **Çözüm: Tablo Geri Dönüşümü (Recycling):** Warband Nexus, veri işleme sırasında kullandığı tabloları `nil`'e eşitlemek yerine, `wipe()` fonksiyonu ile temizleyip tekrar kullanmalıdır. Ace3 kütüphanesi bu konuda yardımcı araçlar sunar.
*   **Olay Filtreleme (Event Throttling):** `BAG_UPDATE` olayı, oyun içinde çok sık tetiklenir (bazen saniyede onlarca kez). Warband Nexus, bu olaya her tepki verdiğinde tüm veritabanını taramak yerine, `C_Timer.After` veya AceBucket kullanarak güncellemeleri 0.5 saniyelik periyotlarla işlemelidir. Bu, CPU kullanımını %90 oranında azaltabilir.

### 6.2. API Soyutlama Katmanı (Abstraction Layer)

Blizzard, genişleme paketleri arasında API isimlerini değiştirmeyi sever (Örn: `GetContainerNumSlots` -> `C_Container.GetContainerNumSlots`). Warband Nexus, bu değişikliklerden minimum düzeyde etkilenmek için bir soyutlama katmanı kullanmalıdır.
```lua
-- Wrapper Fonksiyon Örneği
function WarbandNexus:GetBagSize(bagID)
    if C_Container and C_Container.GetContainerNumSlots then
        return C_Container.GetContainerNumSlots(bagID) -- Modern API
    elseif GetContainerNumSlots then
        return GetContainerNumSlots(bagID) -- Legacy API (Fallback)
    else
        return 0 -- Güvenli çıkış
    end
end